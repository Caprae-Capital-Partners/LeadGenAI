server {
  listen 80;
  server_name api.capraeleadseekers.site;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  server_name api.capraeleadseekers.site;

  ssl_certificate     /etc/letsencrypt/live/api.capraeleadseekers.site/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.capraeleadseekers.site/privkey.pem;

  # --- CORS headers for both routes ---
  set $cors_headers "
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
  ";

  # --- Health check route ---
  location = /api/health {
    proxy_pass         http://backend:5050/health;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # --- Phase 2 (Flask) backend ---
  location /api/ {
    proxy_pass         http://backend:5050;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
      add_header Access-Control-Allow-Headers "Content-Type, Authorization";
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "Content-Type, Authorization";
  }

  # --- Phase 1 (Quart) backend ---
  location /scraper/ {
    proxy_pass         http://scraper:5050/api/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_connect_timeout 0;
    proxy_read_timeout    0;
    proxy_send_timeout    0;
    send_timeout          0;

    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
      add_header Access-Control-Allow-Headers "Content-Type, Authorization";
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "Content-Type, Authorization";
  }
}
