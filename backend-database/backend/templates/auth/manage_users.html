{% extends "base.html" %}

{% block title %}Manage Users - LeadGen{% endblock %}

{% block additional_styles %}
<style>
    .user-management-container {
        padding: 30px;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        background: var(--card-bg);
        color: var(--text-color);
        border-radius: 12px;
        box-sizing: border-box;
    }

    .search-container {
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
        width: 100%;
    }

    .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--background-color);
        color: var(--text-color);
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(58, 129, 123, 0.1);
    }

    .search-input::placeholder {
        color: var(--text-muted);
    }

    .search-button {
        padding: 12px 24px;
        background: var(--primary-color);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-button:hover {
        background: var(--secondary-color);
    }

    .search-button svg {
        width: 16px;
        height: 16px;
    }

    .user-card {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .section-heading {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border-color);
    }

    .user-table {
        width: 100%;
        min-width: 1000px;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--card-bg);
        color: var(--text-color);
        margin-bottom: 0;
    }

    .user-table th {
        text-align: left;
        padding: 12px 20px;
        border-bottom: 2px solid var(--border-color);
        color: var(--primary-color);
        font-weight: 600;
        background: var(--card-bg);
    }

    .user-table td {
        padding: 12px 20px;
        border-bottom: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
    }

    .user-table tr:last-child td {
        border-bottom: none;
    }

    .user-table tr:hover {
        background-color: #232b3a;
    }

    .role-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .role-badge.admin {
        background-color: var(--primary-color);
        color: #fff;
    }

    .role-badge.developer {
        background-color: var(--secondary-color);
        color: #fff;
    }

    .role-badge.user {
        background-color: var(--border-color);
        color: var(--text-color);
    }

    .actions-cell {
        display: flex;
        gap: 10px;
    }

    .btn-user {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
        background: var(--primary-color);
        color: #fff;
    }

    .btn-user:hover {
        background: var(--secondary-color);
    }

    .btn-delete-user {
        background-color: var(--danger-color);
        color: white;
    }

    .btn-delete-user:hover {
        background-color: #b91c1c;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        color: var(--text-color);
        width: 400px;
        border: 1px solid var(--border-color);
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .close {
        float: right;
        color: var(--text-muted);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: var(--text-color);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
    }

    input[type="text"], 
    input[type="email"], 
    input[type="password"],
    select,
    .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    input[type="text"]:disabled,
    input[type="email"]:disabled,
    input[type="password"]:disabled,
    select:disabled,
    .form-select:disabled {
        background-color: var(--background-color);
        color: var(--text-muted);
        cursor: not-allowed;
    }

    .form-select option {
        background-color: var(--card-bg);
        color: var(--text-color);
        padding: 8px;
    }

    .user-table-wrapper {
        width: 100%;
        overflow-x: auto;
        border-radius: 8px;
        background: var(--card-bg);
        margin-bottom: 20px;
    }

    .alert-container {
        margin-bottom: 20px;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
    }

    .alert-success {
        color: #10b981;
        border-color: #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }

    .alert-danger {
        color: #ef4444;
        border-color: #ef4444;
        background-color: rgba(239, 68, 68, 0.1);
    }

    .alert-warning {
        color: #f59e0b;
        border-color: #f59e0b;
        background-color: rgba(245, 158, 11, 0.1);
    }

    .alert-info {
        color: #3b82f6;
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="user-management-container">
    <h1>Manage Users</h1>

    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <p>Manage system users and their permissions</p>
        </div>
        <a href="{{ url_for('auth.signup') }}" class="btn-user btn-edit-role" style="text-decoration: none; padding: 10px 20px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create New User
        </a>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <input type="text" 
               id="userSearch" 
               class="search-input" 
               placeholder="Search by username, email, or company..."
               onkeyup="searchUsers()">
        <!-- <button class="search-button" onclick="searchUsers()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            Search
        </button> -->
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Add Toast Container -->
    <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Admin and Developer Users -->
    <div class="user-card">
        <h2 class="section-heading">Administrators & Developers</h2>
        <div class="user-table-wrapper">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    {% if user.is_staff() %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="role-badge {{ user.role }}">{{ user.role }}</span>
                        </td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        <td class="actions-cell">
                            <button class="btn-user btn-edit-role" onclick="openEditModal('{{ user.user_id }}', '{{ user.username }}', '{{ user.role }}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit Role
                            </button>

                            {% if user.user_id != current_user.user_id %}
                            <button class="btn-user btn-delete-user" data-user-id="{{ user.user_id }}" onclick="deleteUser('{{ user.user_id }}', '{{ user.username }}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                                Delete
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Regular Users -->
    <div class="user-card">
        <h2 class="section-heading">Regular Users</h2>
        <div class="user-table-wrapper">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Company</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    {% if user.role == 'user' %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.company or '-' }}</td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        <td class="actions-cell">
                            <button class="btn-user btn-edit-role" onclick="openEditModal('{{ user.user_id }}', '{{ user.username }}', '{{ user.role }}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit Role
                            </button>

                            <button class="btn-user btn-delete-user" data-user-id="{{ user.user_id }}" onclick="deleteUser('{{ user.user_id }}', '{{ user.username }}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Role Modal -->
    <div id="editRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h2 class="modal-title">Edit User Role</h2>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('auth.update_user_role') }}">
                    <input type="hidden" id="user_id" name="user_id">

                    <div class="form-group">
                        <label class="form-label" for="username">Username</label>
                        <input type="text" id="username" class="form-select" disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="role">Role</label>
                        <select id="role" name="role" class="form-select">
                            <option value="user">User</option>
                            <option value="developer">Developer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-user" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn-user btn-edit-role">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Edit Role Modal
    const editModal = document.getElementById('editRoleModal');

    function openEditModal(userId, username, role) {
        document.getElementById('user_id').value = userId;
        document.getElementById('username').value = username;
        document.getElementById('role').value = role;
        editModal.style.display = 'block';
    }

    function closeEditModal() {
        editModal.style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        if (event.target == editModal) {
            closeEditModal();
        }
    }

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.style.minWidth = '350px';
        toast.style.maxWidth = '500px';
        toast.style.marginBottom = '10px';
        toast.style.whiteSpace = 'pre-line'; // Allow line breaks
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        toast.style.transition = 'all 0.3s ease-in-out';
        toast.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span style="flex: 1; margin-right: 10px;">${message}</span>
                <button type="button" class="close" style="font-size: 20px; background: none; border: none; color: inherit; flex-shrink: 0;" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
        `;
        document.getElementById('toastContainer').appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        }, 50);

        // Auto remove after delay
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            setTimeout(() => toast.remove(), 300);
        }, 8000); // Show for 8 seconds for longer messages
    }

    // Delete User with confirmation and error handling
    async function deleteUser(userId, username) {
        try {
            // First, check what data the user has
            const checkResponse = await fetch(`/api/auth/check_user_data/${userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const checkData = await checkResponse.json();
            let confirmationMessage = `Are you sure you want to delete user "${username}"?`;

            if (checkData.has_data) {
                confirmationMessage += '\n\nThis user has the following data that will also be deleted:\n';
                if (checkData.drafts_count > 0) {
                    confirmationMessage += `• ${checkData.drafts_count} edit draft(s)\n`;
                }
                if (checkData.user_lead_drafts_count > 0) {
                    confirmationMessage += `• ${checkData.user_lead_drafts_count} lead draft(s)\n`;
                }
                if (checkData.audit_logs_count > 0) {
                    confirmationMessage += `• ${checkData.audit_logs_count} audit log(s)\n`;
                }
                if (checkData.subscription_count > 0) {
                    confirmationMessage += `• ${checkData.subscription_count} subscription record(s)\n`;
                }
                confirmationMessage += '\nThis action cannot be undone!';
            } else {
                confirmationMessage += '\n\nThis action cannot be undone!';
            }

            if (!confirm(confirmationMessage)) {
                return;
            }

            const response = await fetch(`/api/auth/delete_user/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.error || 'Failed to delete user', 'danger');
                return;
            }

            // Show detailed success message
            let successMessage = data.message;
            if (data.deleted_data) {
                const deletedItems = [];
                if (data.deleted_data.drafts > 0) {
                    deletedItems.push(`${data.deleted_data.drafts} edit draft(s)`);
                }
                if (data.deleted_data.user_lead_drafts > 0) {
                    deletedItems.push(`${data.deleted_data.user_lead_drafts} lead draft(s)`);
                }
                if (data.deleted_data.audit_logs > 0) {
                    deletedItems.push(`${data.deleted_data.audit_logs} audit log(s)`);
                }
                if (data.deleted_data.subscription > 0) {
                    deletedItems.push('subscription data');
                }
                
                if (deletedItems.length > 0) {
                    successMessage += `\nDeleted: ${deletedItems.join(', ')}`;
                }
            }

            // Remove the user's row from both tables
            const tables = document.querySelectorAll('.user-table');
            tables.forEach(table => {
                const rows = table.getElementsByTagName('tr');
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.querySelector(`button[data-user-id="${userId}"]`)) {
                        row.remove();
                        break;
                    }
                }
            });

            showToast(successMessage, 'success');
        } catch (error) {
            console.error('Error deleting user:', error);
            showToast('An error occurred while deleting the user', 'danger');
        }
    }

    function searchUsers() {
        const searchInput = document.getElementById('userSearch').value.toLowerCase();
        const tables = document.querySelectorAll('.user-table');
        
        tables.forEach(table => {
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
                const row = rows[i];
                const username = row.cells[0].textContent.toLowerCase();
                const email = row.cells[1].textContent.toLowerCase();
                const companyOrRole = row.cells[2].textContent.toLowerCase();
                
                if (username.includes(searchInput) || 
                    email.includes(searchInput) || 
                    companyOrRole.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }

    // Add event listener for Enter key on search input
    document.getElementById('userSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchUsers();
        }
    });
</script>
{% endblock %}