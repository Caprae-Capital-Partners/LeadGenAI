{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-lightning-charge-fill fs-2 me-2 text-warning"></i>
                        <h5 class="card-title mb-0">Credits Remaining</h5>
                    </div>
                    <h2 id="credits-remaining" class="fw-bold display-5">...</h2>
                    <div id="credit-alert"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-people-fill fs-2 me-2 text-info"></i>
                        <h5 class="card-title mb-0">Total Leads</h5>
                    </div>
                    <h2 id="total-leads" class="fw-bold display-5">...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-bar-chart-fill fs-2 me-2 text-success"></i>
                        <h5 class="card-title mb-0">Leads Status</h5>
                    </div>
                    <ul class="list-unstyled mb-0" id="status-list"></ul>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm bg-dark text-white mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Recent Leads</h5>
                <a href="{{ url_for('lead.view_leads') }}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="recent-leads-body">
                        <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
async function loadDashboard() {
    // Get credits
    const creditsResp = await fetch('/api/subscription/credits');
    const creditsData = await creditsResp.json();
    document.getElementById('credits-remaining').innerText = creditsData.credits_remaining ?? '-';
    if (creditsData.credits_remaining !== undefined && creditsData.credits_remaining <= 3) {
        document.getElementById('credit-alert').innerHTML = '<span class="badge bg-danger">Low credits!</span>';
    }

    // Get leads summary
    const leadsResp = await fetch('/api/leads/summary');
    const leadsData = await leadsResp.json();
    document.getElementById('total-leads').innerText = leadsData.total ?? '-';

    // Status list
    const statusList = document.getElementById('status-list');
    statusList.innerHTML = '';
    for (const [status, count] of Object.entries(leadsData.status_counts || {})) {
        statusList.innerHTML += `<li><span class="badge bg-secondary me-2">${status}</span> ${count}</li>`;
    }

    // Recent leads
    const recentResp = await fetch('/api/leads?per_page=5');
    const recentData = await recentResp.json();
    const tbody = document.getElementById('recent-leads-body');
    tbody.innerHTML = '';
    (recentData.leads || []).forEach(lead => {
        tbody.innerHTML += `<tr>
            <td>${lead.company || '-'}</td>
            <td><span class="badge bg-info">${lead.status || '-'}</span></td>
            <td>${lead.created_at ? lead.created_at.split('T')[0] : '-'}</td>
        </tr>`;
    });
    if (!recentData.leads || recentData.leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No leads found.</td></tr>';
    }
}
loadDashboard();
</script>
{% endblock %} 