<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lead Enrichment Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        .missing { color: red; }
        .enriched { color: green; }
        .btn { padding: 4px 10px; cursor: pointer; }
        .id-cell {
          max-width: 180px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          cursor: pointer;
          user-select: all;
          position: relative;
        }
        .copy-btn {
          margin-left: 4px;
          font-size: 10px;
          padding: 2px 6px;
          cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Lead Enrichment Test</h1>

    <h2>1. Get Leads Enrichment Status</h2>
    <button class="btn" onclick="fetchLeads()">Fetch Leads</button>
    <button class="btn" onclick="enrichSelectedLeads()">Enrich Selected</button>
    <div id="leads-status"></div>
    <div id="enrich-selected-result"></div>

    <h2>2. Enrich a Lead</h2>
    <input type="text" id="enrich-lead-id" placeholder="Enter Lead ID">
    <button class="btn" onclick="enrichLead()">Enrich</button>
    <div id="enrich-result"></div>

    <h2>3. Check Missing Fields (Batch)</h2>
    <textarea id="batch-lead-ids" rows="3" cols="40" placeholder="Enter lead IDs, comma separated"></textarea><br>
    <button class="btn" onclick="checkMissing()">Check Missing</button>
    <div id="batch-result"></div>

    <h2>4. Upload/Update Lead by ID (Test /api/upload_leads)</h2>
    <textarea id="upload-leads-json" rows="6" cols="80" placeholder='Paste JSON array of leads here...'></textarea><br>
    <button class="btn" onclick="uploadLeadsById()">Upload/Update</button>
    <div id="upload-leads-result"></div>

    <script>
        function fetchLeads(page=1) {
            fetch(`/api/leads/enrichment-status?page=${page}&per_page=10`)
                .then(res => res.json())
                .then(data => {
                    let html = `<p>Total: ${data.total} | Page: ${data.current_page}/${data.pages}</p>`;
                    html += `<table><tr>
                        <th><input type='checkbox' id='select-all' onclick='toggleSelectAll(this)'></th>
                        <th>ID</th><th>Company</th><th>Owner Email</th>
                        <th>Owner Phone</th><th>Website</th><th>Owner LinkedIn</th>
                        <th>Status</th><th>Action</th>
                    </tr>`;
                    data.leads.forEach(lead => {
                        const status = lead.enrichment_status.is_fully_enriched
                            ? '<span class="enriched">Enriched</span>'
                            : `<span class="missing">Missing: ${lead.enrichment_status.missing_fields.join(', ')}</span>`;
                        html += `<tr>
                            <td><input type='checkbox' class='row-select' value='${lead.lead_id}'></td>
                            <td class="id-cell" title="${lead.lead_id}">
                              <span class="lead-id-text">${lead.lead_id}</span>
                              <button class="copy-btn" onclick="copyToClipboard('${lead.lead_id}')">Copy</button>
                            </td>
                            <td>${lead.company}</td>
                            <td>${lead.owner_email || '-'}</td>
                            <td>${lead.owner_phone_number || '-'}</td>
                            <td>${lead.website || '-'}</td>
                            <td>${lead.owner_linkedin || '-'}</td>
                            <td>${status}</td>
                            <td><button class="btn" onclick="enrichLead('${lead.lead_id}')">Enrich</button></td>
                        </tr>`;
                    });
                    html += `</table>`;
                    document.getElementById('leads-status').innerHTML = html;
                });
        }

        function toggleSelectAll(source) {
            document.querySelectorAll('.row-select').forEach(cb => cb.checked = source.checked);
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
        }

        async function enrichSelectedLeads() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('Select at least one lead!');
                return;
            }
            
            // Gunakan endpoint enrich-multiple
            try {
                const response = await fetch('/api/leads/enrich-multiple', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lead_ids: ids })
                        });
                
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                    }

            // Tampilkan hasil di tabel
            let html = '<h3>Result</h3><table><tr><th>ID</th><th>Company</th><th>Owner Email</th><th>Owner Phone</th><th>Website</th><th>Owner LinkedIn</th><th>Status</th></tr>';
                data.results.forEach(l => {
                    const status = l.error ? l.error : 'Enriched';
                html += `<tr>
                    <td class="id-cell">${l.lead_id || l.id}</td>
                    <td>${l.company || '-'}</td>
                    <td>${l.owner_email || '-'}</td>
                    <td>${l.owner_phone_number || '-'}</td>
                    <td>${l.website || '-'}</td>
                    <td>${l.owner_linkedin || '-'}</td>
                        <td>${status}</td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('enrich-selected-result').innerHTML = html;

                // Refresh tabel leads
                fetchLeads();
            } catch (err) {
                document.getElementById('enrich-selected-result').innerHTML = 
                    `<div style="color: red;">Error: ${err.message}</div>`;
            }
        }

        function enrichLead(leadId=null) {
            if (!leadId) {
                leadId = document.getElementById('enrich-lead-id').value.trim();
            }
            if (!leadId) {
                alert('Please enter a Lead ID');
                return;
            }
            fetch(`/api/leads/${leadId}/enrich`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('enrich-result').innerHTML =
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                });
        }

        function checkMissing() {
            const ids = document.getElementById('batch-lead-ids').value
                .split(',').map(x => x.trim()).filter(x => x);
            if (ids.length === 0) {
                alert('Enter at least one Lead ID');
                return;
            }
            fetch('/api/leads/check-missing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_ids: ids })
            })
            .then(res => res.json())
            .then(data => {
                let html = '<table><tr><th>Lead ID</th><th>Missing Fields</th><th>Status</th></tr>';
                data.results.forEach(r => {
                    html += `<tr>
                        <td>${r.lead_id}</td>
                        <td>${r.missing_fields === null ? '-' : r.missing_fields.join(', ')}</td>
                        <td>${r.status}</td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('batch-result').innerHTML = html;
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('Copied: ' + text);
            }, function(err) {
                alert('Failed to copy!');
            });
        }

        function uploadLeadsById() {
            let jsonText = document.getElementById('upload-leads-json').value.trim();
            if (!jsonText) {
                alert('Paste JSON data!');
                return;
            }
            let data;
            try {
                data = JSON.parse(jsonText);
            } catch (e) {
                alert('Invalid JSON!');
                return;
            }
            fetch('/api/upload_leads', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(resp => {
                document.getElementById('upload-leads-result').innerHTML = `<pre>${JSON.stringify(resp, null, 2)}</pre>`;
            })
            .catch(err => {
                document.getElementById('upload-leads-result').innerHTML = `<span style='color:red;'>${err}</span>`;
            });
        }
    </script>
</body>
</html>
