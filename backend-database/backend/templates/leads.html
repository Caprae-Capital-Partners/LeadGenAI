{% extends "base.html" %}
{% block title %}Lead Data{% endblock %}
{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/leads.css') }}">
<style>
.pagination-numbers {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  align-items: center;
  margin-top: 10px;
}
.btn-pagination {
  display: inline-block;
  min-width: 36px;
  padding: 8px 16px;
  border: 1.5px solid #e2e8f0;
  border-radius: 10px;
  background: var(--card-bg);
  color: #222;
  font-weight: 500;
  font-size: 16px;
  text-align: center;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border 0.15s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.btn-pagination.active, .btn-pagination:active {
  background: var(--primary-color, #2563eb);
  color: #fff;
  border-color: var(--primary-color, #2563eb);
  font-weight: bold;
  cursor: default;
  pointer-events: none;
}
.btn-pagination:hover:not(.active) {
  background: #f1f5f9;
  color: var(--primary-color, #2563eb);
  border-color: var(--primary-color, #2563eb);
}
.pagination-ellipsis {
  display: inline-block;
  min-width: 24px;
  padding: 0 6px;
  color: #64748b;
  font-size: 20px;
  font-weight: bold;
  background: none;
  border: none;
  cursor: default;
  pointer-events: none;
}
@media (max-width: 600px) {
  .pagination-numbers {
    gap: 4px;
  }
  .btn-pagination {
    padding: 6px 8px;
    font-size: 14px;
    min-width: 28px;
  }
}
.pagination-bar-flex {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
  gap: 18px;
  margin-top: 10px;
}
.pagination-bar-flex .rows-per-page,
.pagination-bar-flex .page-info,
.pagination-bar-flex .pagination-numbers {
  margin: 0;
}
.pagination-bar-flex .page-info form {
  display: inline-flex;
  gap: 4px;
  align-items: center;
}
@media (max-width: 600px) {
  .pagination-bar-flex {
    flex-direction: column;
    gap: 8px;
  }
}

/* Updated pagination styles */
.pagination-bar-flex {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0;
    padding: 0.5rem;
    background: var(--card-bg);
    border-radius: 8px;
}

.pagination-numbers {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-pagination {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2rem;
    height: 2rem;
    padding: 0 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: #c7cdd6;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
}

.btn-pagination:hover:not(.active) {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: #1e293b;
}

.btn-pagination.active {
    background: var(--primary-color, #2563eb);
    border-color: var(--primary-color, #2563eb);
    color: white;
    font-weight: 600;
}

.pagination-ellipsis {
    color: #64748b;
    font-weight: bold;
    padding: 0 0.25rem;
}

.rows-per-page select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    font-size: 0.875rem;
}

.page-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #475569;
}

.page-info input[type="number"] {
    text-align: center;
}

@media (max-width: 640px) {
    .pagination-bar-flex {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .pagination-numbers {
        order: -1;
    }
    
    .btn-pagination {
        min-width: 1.75rem;
        height: 1.75rem;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <h1 class="animate__animated animate__fadeIn">Lead Data</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="success-message animate__animated animate__fadeInDown">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="filters-container animate__animated animate__fadeIn">
            <div class="filters-header">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" class="search-box" placeholder="Search across all fields..." onkeyup="handleSearchInput(event)">
                    <div id="searchHistory" class="search-history"></div>
                </div>
            </div>

            <div class="filters-body">
                <div class="filters-section">
                    <div class="section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/>
                        </svg>
                        Basic Filters
                    </div>
                    <div class="filters-grid">
                        <!-- <div class="filter-item">
                            <label class="filter-label">Company</label>
                            <select id="companyFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Companies</option>
                                {% for lead in leads %}
                                    {% if lead.company %}
                                    <option value="{{ lead.company }}">{{ lead.company }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div> -->
                        <div class="filter-item">
                            <label class="filter-label">Location</label>
                            <select id="locationFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Locations</option>
                                {% for location in locations %}
                                    <option value="{{ location }}" {% if location == request.args.get('location', '') %}selected{% endif %}>{{ location }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Role/Title</label>
                            <select id="roleFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Roles</option>
                                {% for role in roles %}
                                    <option value="{{ role }}" {% if role == request.args.get('role', '') %}selected{% endif %}>{{ role }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- <div class="filter-item">
                            <label class="filter-label">Lead Status</label>
                            <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                {% for status in statuses %}
                                    {% if status %}
                                    <option value="{{ status }}">{{ status }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div> -->
                        <!-- <div class="filter-item">
                            <label class="filter-label">Revenue</label>
                            <input type="text" id="revenueFilter" class="filter-input" 
                                   placeholder="Min revenue (e.g. $500K, $5M)" 
                                   title="Enter minimum revenue value (e.g. $500K, $5M) to show leads with equal or higher revenue"
                                   onkeyup="applyFilters()">
                        </div> -->
                        <div class="filter-item">
                            <label class="filter-label">Industry</label>
                            <select id="industryFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Industries</option>
                                {% for industry in industries %}
                                    <option value="{{ industry }}" {% if industry == request.args.get('industry', '') %}selected{% endif %}>{{ industry }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filters-footer">
                <div class="filters-footer-left">
                    <button class="btn btn-delete" onclick="clearAllFilters()" title="Clear all filters (basic and advanced)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Clear All Filters
                    </button>
                </div>

                <div class="total-counter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Total: <strong id="totalCount">{{ total }}</strong> leads
                </div>

                <div class="actions-group">
                    <div class="select-all-wrapper">
                        <label class="select-all-label">
                            <input type="checkbox" id="selectAll" class="custom-checkbox" onclick="toggleAllCheckboxes()">
                            Select All
                        </label>
                        <input type="hidden" id="selectAllAcrossPages" name="select_all" value="false">
                    </div>

                    <form id="exportForm" action="{{ url_for('lead.export_leads') }}" method="POST" style="margin: 0;">
                        <button type="button" class="export-btn" id="exportBtn" disabled onclick="showExportFormatDialog()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Export ({{ total }} All)</span>
                        </button>
                    </form>
                    
                    <button class="toggle-advanced" onclick="toggleAdvancedFilters()" aria-expanded="false">
                        Advanced Filters
                        <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Separate Advanced Filters Container -->
        <div class="advanced-filters-container animate__animated" id="advancedFilters">
            <div class="advanced-filters-header">
                <div class="section-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/>
                    </svg>
                    Advanced Filters
                </div>
            </div>

            <div class="filter-instructions">
                <p>Build your filter by:</p>
                <ol>
                    <li>Select a field to filter</li>
                    <li>Choose an operator (equals, contains, etc.)</li>
                    <li>Enter a value</li>
                    <li>Add more conditions with + button if needed</li>
                    <li>Use AND/OR to combine conditions</li>
                </ol>
            </div>

            <div class="filter-group" id="filterGroup1">
                <div class="filter-row">
                    <select class="filter-select field-select" onchange="updateOperatorOptions(this)">
                        <option value="">Select Field</option>
                        <!-- Basic Information -->
                        <option value="company">Company</option>
                        <option value="location">Location</option>
                        <option value="role">Role</option>
                        <option value="owner_first_name">First Name</option>
                        <option value="owner_last_name">Last Name</option>
                        <option value="owner_email">Email</option>
                        <option value="phone">Phone</option>
                        <option value="owner_title">Title</option>
                        <option value="status">Status</option>
                        <!-- Company Information -->
                        <option value="website">Website</option>
                        <option value="industry">Industry</option>
                        <option value="product_category">Product Category</option>
                        <option value="business_type">Business Type</option>
                        <option value="employees">Employees Count</option>
                        <option value="revenue">Revenue</option>
                        <option value="year_founded">Year Founded</option>
                        <option value="bbb_rating">BBB Rating</option>
                        <!-- Location Information -->
                        <option value="street">Street</option>
                        <option value="city">City</option>
                        <option value="state">State</option>
                        <!-- Company Contact -->
                        <option value="company_phone">Company Phone</option>
                        <option value="company_linkedin">Company LinkedIn</option>
                        <!-- Owner Information -->
                        <option value="owner_linkedin">Owner LinkedIn</option>
                        <option value="owner_phone_number">Owner Phone Number</option>
                        <!-- Source Information -->
                        <option value="source">Source</option>
                        
                        <!-- Scoring and Notes -->
                        <option value="additional_notes">Additional Notes</option>
                        
                        <!-- Timestamps -->
                        <option value="created_at">Created Date</option>
                        <option value="updated_at">Last Updated</option>
                    </select>
                    <select class="filter-select operator-select">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts">Starts with</option>
                        <option value="ends">Ends with</option>
                        <option value="greater">Greater than</option>
                        <option value="less">Less than</option>
                    </select>
                    <input type="text" class="filter-input value-input" style="background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color);" placeholder="Enter value...">
                    <select class="filter-select logic-select">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                    <button class="btn btn-sm btn-add-filter" style="color: var(--text-color);" onclick="addFilterRow(this)" title="Add another condition">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-remove-filter" onclick="removeFilterRow(this)" title="Remove this condition">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="advanced-filters-actions">
                <button class="btn btn-apply-filter" onclick="applyFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 11 12 14 22 4"></polyline>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    Apply Filters
                </button>
                <button class="btn btn-clear-filter" onclick="clearAdvancedFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear Advanced Filters
                </button>
            </div>
        </div>

        <!-- Separate Table Section -->
        <div class="table-wrapper">
            <div class="table-container animate__animated animate__fadeInUp">
                <table id="leadsTable">
                    <thead>
                        <tr>
                            <th class="select-all-header">
                                <label class="select-all-label">
                                    <input type="checkbox" id="headerSelectAll" class="custom-checkbox" onclick="toggleAllCheckboxes(this.checked)">
                                </label>
                            </th>
                            <th class="sticky-col id-col">ID</th>
                            <!-- Updated column headers -->
                            <th>Company</th>
                            <th>Owner First Name</th>
                            <th>Owner Last Name</th>
                            <th>Owner Email</th>
                            <th>Phone Number</th>
                            <th>Owner Title</th>
                            <th>Location</th>
                            <!-- Company Info -->
                            <th>Website</th>
                            <th>Company LinkedIn</th>
                            <th>Industry</th>
                            <th>Revenue</th>
                            <th>Product Category</th>
                            <th>Business Type</th>
                            <th>Employees</th>
                            <th>Year Founded</th>
                            <th>BBB Rating</th>
                            <!-- Owner Info -->
                            <th>Owner LinkedIn</th>
                            <th>Owner Phone</th>
                            <th>Company Phone</th>
                            <th>Source</th>
                            <th>Status</th>
                            <!-- Dates -->
                            <th class="date-col">Created Date</th>
                            <th class="date-col">Last Updated</th>
                            <!-- Actions column -->
                            <th class="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in leads %}
                        <tr class="animate__animated animate__fadeIn" data-index="{{ loop.index }}">
                            <td class="checkbox-col">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" class="lead-checkbox custom-checkbox" value="{{ lead.lead_id }}" onchange="updateExportButton()">
                                </div>
                            </td>
                            <td class="sticky-col id-col">{{ lead.lead_id }}</td>
                            <!-- Basic Information -->
                            <td>{{ lead.company or '-' }}</td>
                            <td>{{ lead.owner_first_name or '-' }}</td>
                            <td>{{ lead.owner_last_name or '-' }}</td>
                            <td>{{ lead.owner_email or '-' }}</td>
                            <td>{{ lead.phone or '-' }}</td>
                            <td>{{ lead.owner_title or '-' }}</td>
                            <td>{{ (lead.city ~ ', ' ~ lead.state) if (lead.city and lead.state) else (lead.city or lead.state or '-') }}</td>
                            <!-- Company Details -->
                            <td>{{ lead.website or '-' }}</td>
                            <td>{{ lead.company_linkedin or '-' }}</td>
                            <td>{{ lead.industry or '-' }}</td>
                            <td>
                                {% if lead.revenue is not none %}
                                    {% if lead.revenue >= 1000000 %}
                                        ${{ (lead.revenue / 1000000)|round(2) }} M
                                    {% else %}
                                        ${{ lead.revenue }} M
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="truncate" title="{{ lead.product_category }}">{{ lead.product_category or '-' }}</td>
                            <td>{{ lead.business_type or '-' }}</td>
                            <td>{{ lead.employees or '-' }}</td>
                            <td>{{ lead.year_founded|int if lead.year_founded else '-' }}</td>
                            <td>{{ lead.bbb_rating or '-' }}</td>
                            <td>{{ lead.owner_linkedin or '-' }}</td>
                            <td>{{ lead.owner_phone_number or '-' }}</td>
                            <td>{{ lead.company_phone or '-' }}</td>
                            <td>{{ lead.source or '-' }}</td>
                            <td>{{ lead.status|capitalize or 'New' }}</td>
                            <td class="date-col">{{ lead.created_at.strftime('%Y-%m-%d %H:%M') if lead.created_at else '-' }}</td>
                            <td class="date-col">{{ lead.updated_at.strftime('%Y-%m-%d %H:%M') if lead.updated_at else '-' }}</td>
                            <!-- Actions -->
                            <td class="actions">
                                <!-- Status update for all users -->
                                <form method="POST" action="{{ url_for('lead.update_status', lead_id=lead.lead_id) }}" style="display: inline-block; margin-right: 10px;">
                                    <select name="status" onchange="this.form.submit()" class="status-select" style="padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color);">
                                        <option value="new" {% if lead.status == 'new' %}selected{% endif %}>New</option>
                                        <option value="contacted" {% if lead.status == 'contacted' %}selected{% endif %}>Contacted</option>
                                        <option value="qualified" {% if lead.status == 'qualified' %}selected{% endif %}>Qualified</option>
                                        <option value="proposal" {% if lead.status == 'proposal' %}selected{% endif %}>Proposal</option>
                                        <option value="closed" {% if lead.status == 'closed' %}selected{% endif %}>Closed</option>
                                    </select>
                                </form>
                                
                                {% if current_user.role in ['admin', 'developer'] %}
                                <a href="{{ url_for('lead.edit_lead', lead_id=lead.lead_id) }}" class="btn btn-edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </a>
                                <button type="button" class="btn btn-delete" style="margin-left: 8px;" onclick="deleteLead({{ lead.lead_id }})" title="Delete Lead">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                    Delete
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="bottom-controls-left">
                <a href="{{ url_for('lead.form') }}" class="btn btn-back">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Form
                </a>
            </div>
            <div class="pagination-container">
                <div class="pagination-bar-flex">
                    <!-- Rows per page selector -->
                    <div class="rows-per-page">
                        Rows per page:
                        <form id="paginationForm" method="get" style="display:inline;">
                            <select id="perPageSelect" name="per_page" class="rows-select" onchange="this.form.submit()">
                                <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
                                <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                                <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                                <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                            </select>
                            <!-- Preserve all current filters -->
                            {% for key, value in request.args.items() %}
                                {% if key != 'per_page' and key != 'page' %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endfor %}
                            <input type="hidden" name="page" value="{{ page }}">
                        </form>
                    </div>

                    <!-- Page info and goto -->
                   <!-- <div class="page-info">
                        Page <span>{{ page }}</span> of <span>{{ pages }}</span>
                        <form id="gotoPageForm" method="get" style="display:inline; margin-left:10px;">
                            <input type="number" min="1" max="{{ pages }}" name="page" value="{{ page }}" 
                                   style="width:50px; padding:4px; border:1px solid #e2e8f0; border-radius:4px;">
                            
                            {% for key, value in request.args.items() %}
                                {% if key != 'page' %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endfor %}
                            <button type="submit" class="btn-pagination">Go</button>
                        </form>
                    </div> -->

                    <!-- Pagination numbers -->
                    {% set max_display = 2 %}
                    {% set start_page = [1, page - 2]|max %}
                    {% set end_page = [pages, start_page + max_display - 1]|min %}
                    {% set start_page = [1, end_page - max_display + 1]|max %}
                    {% set args = request.args.to_dict() %}
                    {% if 'page' in args %}{% set _ = args.pop('page') %}{% endif %}
                    <div class="pagination-numbers">
                        {% if page > 1 %}
                            <a href="{{ url_for('lead.view_leads', page=page-1, **args) }}" 
                               class="btn-pagination" title="Previous page">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </a>
                        {% endif %}

                        {% if start_page > 1 %}
                            <a href="{{ url_for('lead.view_leads', page=1, **args) }}" class="btn-pagination">1</a>
                            {% if start_page > 2 %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endif %}

                        {% for p in range(start_page, end_page + 1) %}
                            {% if p == page %}
                                <span class="btn-pagination active">{{ p }}</span>
                            {% else %}
                                <a href="{{ url_for('lead.view_leads', page=p, **args) }}" class="btn-pagination">{{ p }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if end_page < pages %}
                            {% if end_page < pages - 1 %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                            <a href="{{ url_for('lead.view_leads', page=pages, **args) }}" class="btn-pagination">{{ pages }}</a>
                        {% endif %}

                        {% if page < pages %}
                            <a href="{{ url_for('lead.view_leads', page=page+1, **args) }}" 
                               class="btn-pagination" title="Next page">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Export Format Dialog -->
    <div id="exportFormatDialog" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 24px; border-radius: 12px; width: 400px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h3 style="margin-top: 0; color: var(--primary-color); font-size: 24px; text-align: center; margin-bottom: 24px;">Export Options</h3>
            
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 16px; font-weight: 600; font-size: 16px; color: #333;">What to Export:</div>
                <div style="display: flex; margin-bottom: 24px; gap: 20px;">
                    <label style="display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; border: 1px solid #e2e8f0; background-color: #f8fafc; width: 100%; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="exportType" value="selected" style="margin-right: 12px; width: 18px; height: 18px; accent-color: var(--primary-color);"> 
                        <div>
                            <div style="font-weight: 500;">Selected Leads</div>
                            <div style="color: #64748b; font-size: 14px;">(<span id="selectedCount">0</span> leads)</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; border: 1px solid #e2e8f0; background-color: #f8fafc; width: 100%; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="exportType" value="filtered" style="margin-right: 12px; width: 18px; height: 18px; accent-color: var(--primary-color);"> 
                        <div>
                            <div style="font-weight: 500;">Filtered Leads</div>
                            <div style="color: #64748b; font-size: 14px;">(<span id="filteredCount">0</span> leads)</div>
                        </div>
                    </label>
                </div>
                
                <div style="margin-bottom: 16px; font-weight: 600; font-size: 16px; color: #333;">Export Format:</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="exportLeads('csv')" class="btn" style="width: 100%; background: var(--primary-color); color: white; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;">
                        Export as CSV
                    </button>
                    <!-- <button onclick="exportLeads('excel')" class="btn" style="width: 100%; background: var(--success-color); color: white; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;">
                        Export as Excel
                    </button> -->
                </div>
            </div>
            <button onclick="closeExportFormatDialog()" class="btn" style="width: 100%; background: #f1f5f9; color: #475569; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease; margin-top: 16px;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // Add hover functionality for truncated content
        document.querySelectorAll('.truncate').forEach(el => {
            el.addEventListener('mouseenter', function() {
                if (this.offsetWidth < this.scrollWidth) {
                    this.title = this.textContent;
                }
            });
        });
        
        // Apply animation delays based on data-index attribute
        document.querySelectorAll('tr[data-index]').forEach(row => {
            const index = row.getAttribute('data-index');
            row.style.animationDelay = `${index * 0.03}s`;
        });
        
        function toggleAllCheckboxes() {
            // Get both header checkbox and top "Select All" checkbox
            const topSelectAllCheckbox = document.getElementById('selectAll');
            const headerCheckbox = document.getElementById('headerSelectAll');
            
            // Set checked state based on whichever checkbox triggered the event
            const newCheckedState = document.activeElement === headerCheckbox ? 
                                    headerCheckbox.checked : 
                                    topSelectAllCheckbox.checked;
            
            // Sync both checkboxes
            if (headerCheckbox) headerCheckbox.checked = newCheckedState;
            if (topSelectAllCheckbox) topSelectAllCheckbox.checked = newCheckedState;
            
            // Apply checked state to all lead checkboxes
            const checkboxes = document.querySelectorAll('.lead-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox) checkbox.checked = newCheckedState;
            });
            
            // Update export button state
            updateExportButton();
        }

        // Add event listener to sync checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const headerCheckbox = document.getElementById('headerSelectAll');
            const topSelectAllCheckbox = document.getElementById('selectAll');
            
            // Listen for changes on header checkbox
            if (headerCheckbox) {
                headerCheckbox.addEventListener('change', function() {
                    toggleAllCheckboxes();
                });
            }
            
            // Listen for changes on top Select All checkbox
            if (topSelectAllCheckbox) {
                topSelectAllCheckbox.addEventListener('change', function() {
                    toggleAllCheckboxes();
                });
            }
            
            // Listen for changes on individual lead checkboxes to manage the "Select All" state
            document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.lead-checkbox');
                    const checkedCount = document.querySelectorAll('.lead-checkbox:checked').length;
                    
                    // If all checkboxes are checked, set "Select All" to checked
                    // If not all are checked, set "Select All" to unchecked
                    const allChecked = checkedCount === allCheckboxes.length;
                    
                    if (headerCheckbox) headerCheckbox.checked = allChecked;
                    if (topSelectAllCheckbox) topSelectAllCheckbox.checked = allChecked;
                    
                    // Update export button
                    updateExportButton();
                });
            });
            
            // Initialize export button state
            updateExportButton();
        });

        function updateExportButton() {
            const selectedCheckboxes = document.querySelectorAll('.lead-checkbox:checked');
            const exportBtn = document.getElementById('exportBtn');
            const exportForm = document.getElementById('exportForm');
            const selectAllAcrossPages = document.getElementById('selectAllAcrossPages').value === 'true';
            
            // Remove any existing hidden inputs
            const existingInputs = exportForm.querySelectorAll('input[name="selected_leads[]"]');
            existingInputs.forEach(input => input.remove());
            
            // Add new hidden inputs for selected leads
            selectedCheckboxes.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_leads[]';
                input.value = checkbox.value;
                exportForm.appendChild(input);
            });
            
            const selectedCount = selectedCheckboxes.length;
            const totalCount = parseInt(document.getElementById('totalCount').textContent) || 0;
            
            if (selectAllAcrossPages) {
                exportBtn.disabled = totalCount === 0;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span>Export (${totalCount} All)</span>
                `;
            } else if (selectedCount > 0) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span>Export (${selectedCount} Selected)</span>
                `;
            } else {
                exportBtn.disabled = totalCount === 0;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span>Export (${totalCount} All)</span>
                `;
            }
            
            // Update delete button if it exists
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.disabled = selectedCount === 0;
                deleteBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    <span>Delete Selected (${selectedCount})</span>
                `;
                
                // Update hidden inputs for delete form
                const deleteForm = document.getElementById('deleteMultipleForm');
                if (deleteForm) {
                    // Remove any existing hidden inputs
                    const existingDeleteInputs = deleteForm.querySelectorAll('input[name="selected_leads[]"]');
                    existingDeleteInputs.forEach(input => input.remove());
                    
                    // Add new hidden inputs for selected leads
                    selectedCheckboxes.forEach(checkbox => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selected_leads[]';
                        input.value = checkbox.value;
                        deleteForm.appendChild(input);
                    });
                }
            }
            
            // Update counts in the export dialog
            if (document.getElementById('selectedCount')) {
                document.getElementById('selectedCount').textContent = selectedCount;
            }
            if (document.getElementById('filteredCount')) {
                document.getElementById('filteredCount').textContent = totalCount;
                
                // Update filtered label text
                const filteredCountLabel = document.querySelector('label[for="exportType-filtered"] div, input[name="exportType"][value="filtered"]').closest('label').querySelector('div div:first-child');
                if (filteredCountLabel) {
                    filteredCountLabel.textContent = 'All Leads';
                }
            }
        }
        
        // Function to check if any filter is active
        function isAnyFilterActive() {
            // Check basic filters
            if (document.getElementById('companyFilter').value !== '') return true;
            if (document.getElementById('locationFilter').value !== '') return true;
            if (document.getElementById('roleFilter').value !== '') return true;
            if (document.getElementById('statusFilter').value !== '') return true;
            if (document.getElementById('revenueFilter').value !== '') return true;
            if (document.getElementById('searchInput').value !== '') return true;
            
            // Check advanced filters
            const advancedFilters = document.querySelectorAll('.filter-row');
            for (let row of advancedFilters) {
                const field = row.querySelector('.field-select').value;
                const value = row.querySelector('.value-input').value;
                if (field && value) return true;
            }
            
            return false;
        }

        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advancedFilters');
            const toggleButton = document.querySelector('.toggle-advanced');
            const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                advancedFilters.classList.remove('show');
                toggleButton.setAttribute('aria-expanded', 'false');
            } else {
                advancedFilters.classList.add('show', 'animate__fadeIn');
                toggleButton.setAttribute('aria-expanded', 'true');
            }
        }

        function toggleColumn(columnIndex) {
            const table = document.getElementById('leadsTable');
            const rows = table.getElementsByTagName('tr');
            
            // Toggle header and all cells in the column
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName(i === 0 ? 'th' : 'td');
                if (cells[columnIndex]) {
                    cells[columnIndex].style.display = cells[columnIndex].style.display === 'none' ? '' : 'none';
                }
            }
        }

        function normalizeValue(value) {
            return value ? value.toString().trim().toLowerCase() : '';
        }

        function applyFilters() {
            const location = document.getElementById('locationFilter').value;
            const role = document.getElementById('roleFilter').value;
            const industry = document.getElementById('industryFilter').value;
            let params = new URLSearchParams(window.location.search);

            if (location) params.set('location', location); else params.delete('location');
            if (role) params.set('role', role); else params.delete('role');
            if (industry) params.set('industry', industry); else params.delete('industry');

            // Reset page to 1 when filter changes
            params.set('page', 1);

            window.location.search = params.toString();
        }

        // Remove automatic filter application on input change
        document.addEventListener('DOMContentLoaded', function() {
            // Add change event listeners to all filter dropdowns
            const filters = ['companyFilter', 'locationFilter', 'roleFilter', 'statusFilter', 'revenueFilter'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', applyFilters);
                }
            });

            // Add input event listener to search box
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', applyFilters);
                searchInput.addEventListener('keyup', handleSearchInput);
                
                // Show all search history when focusing on search box
                searchInput.addEventListener('focus', function() {
                    displaySearchHistory(); // Show all history items regardless of input value
                    document.getElementById('searchHistory').classList.add('show');
                });
            }
            
            // Load search history on page load
            loadSearchHistory();
            
            // Close search history when clicking outside
            document.addEventListener('click', function(event) {
                const searchWrapper = document.querySelector('.search-wrapper');
                if (searchWrapper && !searchWrapper.contains(event.target)) {
                    const searchHistory = document.getElementById('searchHistory');
                    if (searchHistory) {
                        searchHistory.classList.remove('show');
                    }
                }
            });


            // Initialize advanced filter field select change listeners
            document.querySelectorAll('.field-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateOperatorOptions(this);
                });
                
                // Initialize operator options for existing rows
                if (select.value) {
                    updateOperatorOptions(select);
                }
            });

            // Initialize export button state
            updateExportButton();
        });

        function clearFilters() {
            // Reset all filter dropdowns
            const filters = ['companyFilter', 'locationFilter', 'roleFilter', 'statusFilter', 'revenueFilter'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.value = '';
                }
            });

            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            // Show all rows
            const table = document.getElementById('leadsTable');
            const rows = table.getElementsByTagName('tr');
            let totalRows = 0;
            
            for (let i = 1; i < rows.length; i++) {
                rows[i].style.display = '';
                totalRows++;
            }

            // Update total count
            document.getElementById('totalCount').textContent = totalRows;

            // Uncheck select all checkboxes
            const topSelectAllCheckbox = document.getElementById('selectAll');
            const headerCheckbox = document.getElementById('headerSelectAll');
            if (topSelectAllCheckbox) topSelectAllCheckbox.checked = false;
            if (headerCheckbox) headerCheckbox.checked = false;

            // Update export button state
            updateExportButton();
        }

        // Update the existing searchTable function to use applyFilters
        function searchTable() {
            applyFilters();
        }
        
        // Initialize search on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for search input
            document.getElementById('searchInput').addEventListener('keyup', handleSearchInput);
            
            // Load search history on page load
            loadSearchHistory();
            
            // Add event listener to show all search history when clicking in the search box
            document.getElementById('searchInput').addEventListener('focus', function() {
                displaySearchHistory(); // Show all history items regardless of input value
                document.getElementById('searchHistory').classList.add('show');
            });
            
            // Close search history when clicking outside
            document.addEventListener('click', function(event) {
                const searchWrapper = document.querySelector('.search-wrapper');
                if (!searchWrapper.contains(event.target)) {
                    document.getElementById('searchHistory').classList.remove('show');
                }
            });
            
            // Add row highlighting on hover
            const tableRows = document.querySelectorAll('#leadsTable tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.classList.add('highlight');
                });
                row.addEventListener('mouseleave', function() {
                    this.classList.remove('highlight');
                });
            });

            // Initialize export button state
            updateExportButton();
        });
        
        // Functions for search history
        function handleSearchInput(event) {
            const searchText = event.target.value.trim().toLowerCase();
            
            // Display search history based on current input
            if (searchText.length > 0) {
                displaySearchHistory(searchText);
                document.getElementById('searchHistory').classList.add('show');
            } else {
                displaySearchHistory(); // Show all history when input is empty
                document.getElementById('searchHistory').classList.add('show');
            }
            
            // Only filter table rows in-place (frontend)
            const table = document.getElementById('leadsTable');
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;
            for (let i = 1; i < rows.length; i++) { // skip header
                const row = rows[i];
                let found = false;
                const cells = row.getElementsByTagName('td');
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchText)) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
                if (found) visibleCount++;
            }
            document.getElementById('totalCount').textContent = visibleCount;
            
            // Add to search history if Enter key is pressed and text is not empty
            if (event.key === 'Enter' && searchText.length > 0) {
                addToSearchHistory(searchText);
            }
        }
        
        function saveSearchQuery(query) {
            // Don't save empty or very short queries
            if (!query || query.length < 3) {
                return;
            }
            
            // Get existing history or initialize an empty array
            let searchHistory = JSON.parse(localStorage.getItem('leadSearchHistory') || '[]');
            
            // Check if the query already exists in history
            const existingIndex = searchHistory.findIndex(item => item.query.toLowerCase() === query.toLowerCase());
            
            if (existingIndex !== -1) {
                // Remove the existing entry so it can be moved to the top
                searchHistory.splice(existingIndex, 1);
            }
            
            // Add the new query at the beginning with timestamp
            searchHistory.unshift({
                query: query,
                timestamp: new Date().toISOString()
            });
            
            // Limit history to 10 items
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            // Save back to localStorage
            localStorage.setItem('leadSearchHistory', JSON.stringify(searchHistory));
            
            // Refresh the display
            loadSearchHistory();
        }
        
        function loadSearchHistory() {
            const searchHistory = document.getElementById('searchHistory');
            const history = JSON.parse(localStorage.getItem('leadSearchHistory') || '[]');
            
            if (history.length === 0) {
                searchHistory.classList.remove('show');
                return;
            }
            
            // Clear the existing history items
            searchHistory.innerHTML = '';
            
            // Add history items
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                
                // Format the timestamp to a relative time (e.g., "2 hours ago")
                const timestamp = new Date(item.timestamp);
                const relativeTime = getRelativeTimeString(timestamp);
                
                historyItem.innerHTML = `
                    <div class="search-history-text">${item.query}</div>
                    <div class="search-history-timestamp">${relativeTime}</div>
                `;
                
                // Add click event to use this search query
                historyItem.addEventListener('click', function() {
                    document.getElementById('searchInput').value = item.query;
                    searchTable();
                    searchHistory.classList.remove('show');
                });
                
                searchHistory.appendChild(historyItem);
            });
            
            // Add a "Clear History" button
            const clearButton = document.createElement('div');
            clearButton.className = 'search-history-clear';
            clearButton.textContent = 'Clear Search History';
            clearButton.addEventListener('click', function(e) {
                e.stopPropagation();
                clearSearchHistory();
            });
            
            searchHistory.appendChild(clearButton);
        }
        
        function displaySearchHistory(filter = '') {
            const searchHistory = document.getElementById('searchHistory');
            const history = JSON.parse(localStorage.getItem('leadSearchHistory') || '[]');
            
            if (history.length === 0) {
                searchHistory.classList.remove('show');
                return;
            }
            
            // Clear the existing history items
            searchHistory.innerHTML = '';
            
            // Filter and add history items
            const filteredHistory = filter 
                ? history.filter(item => item.query.toLowerCase().includes(filter.toLowerCase()))
                : history;
                
            if (filteredHistory.length === 0) {
                searchHistory.classList.remove('show');
                return;
            }
            
            filteredHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                
                // Format the timestamp to a relative time
                const timestamp = new Date(item.timestamp);
                const relativeTime = getRelativeTimeString(timestamp);
                
                historyItem.innerHTML = `
                    <div class="search-history-text">${item.query}</div>
                    <div class="search-history-timestamp">${relativeTime}</div>
                `;
                
                // Add click event to use this search query
                historyItem.addEventListener('click', function() {
                    document.getElementById('searchInput').value = item.query;
                    searchTable();
                    searchHistory.classList.remove('show');
                });
                
                searchHistory.appendChild(historyItem);
            });
            
            // Add a "Clear History" button
            const clearButton = document.createElement('div');
            clearButton.className = 'search-history-clear';
            clearButton.textContent = 'Clear Search History';
            clearButton.addEventListener('click', function(e) {
                e.stopPropagation();
                clearSearchHistory();
            });
            
            searchHistory.appendChild(clearButton);
        }
        
        function clearSearchHistory() {
            localStorage.removeItem('leadSearchHistory');
            document.getElementById('searchHistory').innerHTML = '';
            document.getElementById('searchHistory').classList.remove('show');
        }
        
        function getRelativeTimeString(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'just now';
            }
            
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) {
                return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
            }
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) {
                return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
            }
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 30) {
                return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            }
            
            // For older dates, return the actual date
            return date.toLocaleDateString();
        }

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Add animation class to table rows
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('table tr');
            rows.forEach((row, index) => {
                row.classList.add('animate__animated', 'animate__fadeIn');
                row.style.animationDelay = `${index * 0.05}s`;
            });
        });

        // Add sorting functionality
        function sortTable(columnIndex) {
            const table = document.getElementById('leadsTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            const sortIcon = event.target;
            const isAscending = !sortIcon.classList.contains('asc');
            
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('asc');
            });
            
            if (isAscending) {
                sortIcon.classList.add('asc');
            }
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                // Check if the values are dates
                const aDate = new Date(aValue);
                const bDate = new Date(bValue);
                if (!isNaN(aDate) && !isNaN(bDate)) {
                    return isAscending ? aDate - bDate : bDate - aDate;
                }
                
                // Check if the values are numbers
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                }
                
                // Sort as strings
                return isAscending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            // Reorder the rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Add sort icons to table headers
        document.addEventListener('DOMContentLoaded', function() {
            const headers = document.querySelectorAll('#leadsTable th');
            headers.forEach((header, index) => {
                // Skip checkbox column (index 0), ID column (index 1), and actions column
                if (index > 1 && !header.classList.contains('actions')) {
                    const sortIcon = document.createElement('span');
                    sortIcon.innerHTML = '';
                    sortIcon.className = 'sort-icon';
                    sortIcon.onclick = () => sortTable(index);
                    header.appendChild(sortIcon);
                }
            });
        });

        function clearAdvancedFilters() {
            // Clear all advanced filter inputs
            document.querySelectorAll('.filter-row').forEach((row, index) => {
                if (index === 0) {
                    row.querySelector('.field-select').value = '';
                    row.querySelector('.operator-select').value = 'equals';
                    row.querySelector('.value-input').value = '';
                    row.querySelector('.logic-select').value = 'AND';
                } else {
                    row.remove();
                }
            });
            applyFilters();
        }
        
        // Function to parse revenue values like $5M, $1.5M, etc.
        function parseRevenueValue(revenueStr) {
            if (!revenueStr || revenueStr === '-') return null;
            
            // Handle "nan" value
            if (revenueStr.toLowerCase() === 'nan') return 0;
            
            // Special case for < or > with revenue
            if (revenueStr.includes('<') || revenueStr.includes('>')) {
                // Extract the numeric part after < or >
                const match = revenueStr.match(/[<>]\s*\$?(\d+(?:\.\d+)?[MmKk]?)/);
                if (match && match[1]) {
                    const numericPart = match[1];
                    let value;
                    
                    if (numericPart.endsWith('M') || numericPart.endsWith('m')) {
                        value = parseFloat(numericPart.slice(0, -1));
                    } else if (numericPart.endsWith('K') || numericPart.endsWith('k')) {
                        value = parseFloat(numericPart.slice(0, -1)) / 1000; // Convert K to M
                    } else {
                        value = parseFloat(numericPart);
                    }
                    
                    // For < we return a small value, for > we return the actual value
                    return revenueStr.includes('<') ? Math.max(0.1, value - 0.1) : value;
                }
            }
            
            const cleanStr = revenueStr.replace(/[$,]/g, '').trim();
            
            if (cleanStr.endsWith('M') || cleanStr.endsWith('m')) {
                // Convert $XM format to a number (millions)
                const numPart = parseFloat(cleanStr.slice(0, -1));
                return isNaN(numPart) ? null : numPart;
            } else if (cleanStr.endsWith('K') || cleanStr.endsWith('k')) {
                // Convert $XK format to a number (thousands)
                const numPart = parseFloat(cleanStr.slice(0, -1));
                return isNaN(numPart) ? null : numPart / 1000; 
            } else {
                // Try to parse as a direct number
                const numPart = parseFloat(cleanStr);
                return isNaN(numPart) ? null : numPart;
            }
        }

        function addFilterRow(button) {
            const filterGroup = document.getElementById('filterGroup1');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <select class="filter-select field-select" onchange="updateOperatorOptions(this)">
                    <option value="">Select Field</option>
                    <!-- Basic Information -->
                    <option value="company">Company</option>
                    <option value="location">Location</option>
                    <option value="role">Role</option>
                    <option value="owner_first_name">First Name</option>
                    <option value="owner_last_name">Last Name</option>
                    <option value="owner_email">Email</option>
                    <option value="phone">Phone</option>
                    <option value="owner_title">Title</option>
                    <option value="status">Status</option>
                    <!-- Company Information -->
                    <option value="website">Website</option>
                    <option value="industry">Industry</option>
                    <option value="product_category">Product Category</option>
                    <option value="business_type">Business Type</option>
                    <option value="employees">Employees Count</option>
                    <option value="revenue">Revenue</option>
                    <option value="year_founded">Year Founded</option>
                    <option value="bbb_rating">BBB Rating</option>
                    <!-- Location Information -->
                    <option value="street">Street</option>
                    <option value="city">City</option>
                    <option value="state">State</option>
                    <!-- Company Contact -->
                    <option value="company_phone">Company Phone</option>
                    <option value="company_linkedin">Company LinkedIn</option>
                    <!-- Owner Information -->
                    <option value="owner_linkedin">Owner LinkedIn</option>
                    <option value="owner_phone_number">Owner Phone Number</option>
                    <!-- Source Information -->
                    <option value="source">Source</option>
                    
                    <!-- Scoring and Notes -->
                    <option value="additional_notes">Additional Notes</option>
                    
                    <!-- Timestamps -->
                    <option value="created_at">Created Date</option>
                    <option value="updated_at">Last Updated</option>
                </select>
                <select class="filter-select operator-select">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts">Starts with</option>
                    <option value="ends">Ends with</option>
                    <option value="greater">Greater than</option>
                    <option value="less">Less than</option>
                </select>
                <input type="text" class="filter-input value-input" placeholder="Enter value...">
                <select class="filter-select logic-select">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
                <button class="btn btn-sm btn-add-filter" onclick="addFilterRow(this)" title="Add another condition">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="btn btn-sm btn-remove-filter" onclick="removeFilterRow(this)" title="Remove this condition">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            `;
            filterGroup.appendChild(newRow);
            
            // Initialize the operator options based on field type
            updateOperatorOptions(newRow.querySelector('.field-select'));
        }

        // Function to update operator options based on selected field
        function updateOperatorOptions(fieldSelect) {
            const row = fieldSelect.closest('.filter-row');
            const operatorSelect = row.querySelector('.operator-select');
            const field = fieldSelect.value;
            
            // Reset operator select
            operatorSelect.innerHTML = '';
            
            // Define operators based on field type
            if (['revenue', 'year_founded', 'owner_age'].includes(field)) {
                // Numeric fields
                operatorSelect.innerHTML = `
                    <option value="equals">Equals</option>
                    <option value="greater">Greater than</option>
                    <option value="less">Less than</option>
                `;
            } else if (['created_at', 'updated_at'].includes(field)) {
                // Date fields
                operatorSelect.innerHTML = `
                    <option value="equals">Equals</option>
                    <option value="greater">After</option>
                    <option value="less">Before</option>
                    <option value="contains">Contains</option>
                `;
            } else {
                // Text fields (default)
                operatorSelect.innerHTML = `
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts">Starts with</option>
                    <option value="ends">Ends with</option>
                `;
            }
            
            // Update placeholder text for the value input
            const valueInput = row.querySelector('.value-input');
            if (['created_at', 'updated_at'].includes(field)) {
                valueInput.placeholder = "YYYY-MM-DD";
            } else if (field === 'revenue') {
                valueInput.placeholder = "e.g. $5M or $500K";
            } else if (['year_founded', 'owner_age'].includes(field)) {
                valueInput.placeholder = "Enter number...";
            } else {
                valueInput.placeholder = "Enter value...";
            }
        }

        // Add event listener to initialize operator options for the first row
        document.addEventListener('DOMContentLoaded', function() {
            // Find the initial field select and set up its operator options
            const initialFieldSelect = document.querySelector('.filter-row .field-select');
            if (initialFieldSelect) {
                initialFieldSelect.addEventListener('change', function() {
                    updateOperatorOptions(this);
                });
            }
            
            // Rest of the DOMContentLoaded code...
        });

        function removeFilterRow(button) {
            const row = button.closest('.filter-row');
            const filterGroup = row.parentElement;
            
            // Only remove if there's more than one row
            if (filterGroup.children.length > 1) {
                row.remove();
            } else {
                // If it's the last row, just clear the values
                row.querySelector('.field-select').value = '';
                row.querySelector('.operator-select').value = 'equals';
                row.querySelector('.value-input').value = '';
                row.querySelector('.logic-select').value = 'AND';
            }
        }

        function clearAllFilters() {
            if (document.getElementById('companyFilter')) document.getElementById('companyFilter').value = '';
            if (document.getElementById('locationFilter')) document.getElementById('locationFilter').value = '';
            if (document.getElementById('roleFilter')) document.getElementById('roleFilter').value = '';
            if (document.getElementById('statusFilter')) document.getElementById('statusFilter').value = '';
            if (document.getElementById('revenueFilter')) document.getElementById('revenueFilter').value = '';
            if (document.getElementById('industryFilter')) document.getElementById('industryFilter').value = '';
            document.getElementById('searchInput').value = '';
            // Clear advanced filters
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters) {
                const filterRows = advancedFilters.querySelectorAll('.filter-row');
                filterRows.forEach((row, index) => {
                    if (index === 0) {
                        row.querySelector('.field-select').value = '';
                        row.querySelector('.operator-select').value = 'equals';
                        row.querySelector('.value-input').value = '';
                        row.querySelector('.logic-select').value = 'AND';
                    } else {
                        row.remove();
                    }
                });
                advancedFilters.classList.remove('show');
                const toggleButton = document.querySelector('.toggle-advanced');
                if (toggleButton) {
                    toggleButton.setAttribute('aria-expanded', 'false');
                }
            }
            applyFilters();
        }

        function showExportFormatDialog() {
            // Update the counts before showing the dialog
            const selectedCount = document.querySelectorAll('.lead-checkbox:checked').length;
            const totalCount = parseInt(document.getElementById('totalCount').textContent) || 0;
            // Update counts in the export dialog
            if (document.getElementById('selectedCount')) {
                document.getElementById('selectedCount').textContent = selectedCount;
            }
            if (document.getElementById('filteredCount')) {
                document.getElementById('filteredCount').textContent = totalCount;
            }
            // Set radio button and select_all hidden input
            const selectedRadio = document.querySelector('input[name="exportType"][value="selected"]');
            const filteredRadio = document.querySelector('input[name="exportType"][value="filtered"]');
            const selectAllAcrossPages = document.getElementById('selectAllAcrossPages');
            if (selectedCount > 0) {
                selectedRadio.checked = true;
                selectAllAcrossPages.value = 'false';
            } else {
                filteredRadio.checked = true;
                selectAllAcrossPages.value = 'true';
            }
            // Add event listeners to radio buttons
            selectedRadio.onclick = function() {
                selectAllAcrossPages.value = 'false';
            };
            filteredRadio.onclick = function() {
                selectAllAcrossPages.value = 'true';
            };
            document.getElementById('exportFormatDialog').style.display = 'block';
        }

        function closeExportFormatDialog() {
            document.getElementById('exportFormatDialog').style.display = 'none';
        }

        function exportLeads(format) {
            const form = document.getElementById('exportForm');
            // Hapus input file_format yang sudah ada
            const oldInputs = form.querySelectorAll('input[name="file_format"]');
            oldInputs.forEach(input => input.remove());
            // Tambahkan input file_format baru
            let formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'file_format';
            formatInput.value = format;
            form.appendChild(formatInput);
            // Get export type (selected or filtered)
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            let exportTypeInput = document.createElement('input');
            exportTypeInput.type = 'hidden';
            exportTypeInput.name = 'export_type';
            exportTypeInput.value = exportType;
            form.appendChild(exportTypeInput);
            // If exporting filtered data, add current filter values
            if (exportType === 'filtered') {
                // Get current filter values
                const companyFilter = document.getElementById('companyFilter').value;
                const locationFilter = document.getElementById('locationFilter').value;
                const roleFilter = document.getElementById('roleFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const revenueFilter = document.getElementById('revenueFilter').value;
                const searchInput = document.getElementById('searchInput').value;
                
                // Add filter values as hidden inputs
                if (companyFilter) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'company';
                    input.value = companyFilter;
                    form.appendChild(input);
                }
                
                if (locationFilter) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'location';
                    input.value = locationFilter;
                    form.appendChild(input);
                }
                
                if (roleFilter) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'role';
                    input.value = roleFilter;
                    form.appendChild(input);
                }
                
                if (statusFilter) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'status';
                    input.value = statusFilter;
                    form.appendChild(input);
                }
                
                if (revenueFilter) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'revenue';
                    input.value = revenueFilter;
                    form.appendChild(input);
                }
                
                if (searchInput) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'search';
                    input.value = searchInput;
                    form.appendChild(input);
                }
                
                // Add advanced filters if they exist (future implementation)
            }
            
            form.submit();
            closeExportFormatDialog();
        }

        // Close dialog when clicking outside
        window.onclick = function(event) {
            const dialog = document.getElementById('exportFormatDialog');
            if (event.target == dialog) {
                closeExportFormatDialog();
            }
            
            const deleteDialog = document.getElementById('deleteConfirmDialog');
            if (deleteDialog && event.target == deleteDialog) {
                closeDeleteConfirmDialog();
            }
        }
        
        // Function to confirm deletion of multiple leads
        function confirmDeleteSelected() {
            const selectedCheckboxes = document.querySelectorAll('.lead-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            if (selectedCount === 0) {
                return;
            }
            
            // Create confirmation dialog if it doesn't exist
            let deleteDialog = document.getElementById('deleteConfirmDialog');
            
            if (!deleteDialog) {
                deleteDialog = document.createElement('div');
                deleteDialog.id = 'deleteConfirmDialog';
                deleteDialog.className = 'modal';
                deleteDialog.style.display = 'none';
                deleteDialog.style.position = 'fixed';
                deleteDialog.style.zIndex = '1000';
                deleteDialog.style.left = '0';
                deleteDialog.style.top = '0';
                deleteDialog.style.width = '100%';
                deleteDialog.style.height = '100%';
                deleteDialog.style.backgroundColor = 'rgba(0,0,0,0.5)';
                
                const dialogContent = document.createElement('div');
                dialogContent.className = 'modal-content';
                dialogContent.style.backgroundColor = 'white';
                dialogContent.style.margin = '15% auto';
                dialogContent.style.padding = '24px';
                dialogContent.style.borderRadius = '12px';
                dialogContent.style.width = '400px';
                dialogContent.style.position = 'relative';
                dialogContent.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
                
                deleteDialog.appendChild(dialogContent);
                document.body.appendChild(deleteDialog);
            }
            
            // Update dialog content
            const dialogContent = deleteDialog.querySelector('.modal-content');
            dialogContent.innerHTML = `
                <h3 style="margin-top: 0; color: var(--danger-color); font-size: 24px; text-align: center; margin-bottom: 24px;">Confirm Deletion</h3>
                
                <div style="margin: 20px 0; text-align: center;">
                    <p style="font-size: 16px; margin-bottom: 20px;">Are you sure you want to delete ${selectedCount} selected lead${selectedCount !== 1 ? 's' : ''}?</p>
                    <p style="font-size: 14px; color: #64748B; margin-bottom: 30px;">This action cannot be undone.</p>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="submitDeleteMultiple()" class="btn" style="background: var(--danger-color); color: white; padding: 12px 24px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;">
                            Yes, Delete
                        </button>
                        <button onclick="closeDeleteConfirmDialog()" class="btn" style="background: #f1f5f9; color: #475569; padding: 12px 24px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Show dialog
            deleteDialog.style.display = 'block';
        }
        
        function closeDeleteConfirmDialog() {
            const deleteDialog = document.getElementById('deleteConfirmDialog');
            if (deleteDialog) {
                deleteDialog.style.display = 'none';
            }
        }
        
        function submitDeleteMultiple() {
            document.getElementById('deleteMultipleForm').submit();
            closeDeleteConfirmDialog();
        }

        // Display search history with optional filter text
        function displaySearchHistory(filterText = '') {
            const historyContainer = document.getElementById('searchHistory');
            const searchHistory = getSearchHistory();
            
            // Clear previous history items
            historyContainer.innerHTML = '';
            
            if (searchHistory.length === 0) {
                // If no history, show a message
                const noHistoryItem = document.createElement('div');
                noHistoryItem.className = 'history-item no-results';
                noHistoryItem.textContent = 'No search history';
                historyContainer.appendChild(noHistoryItem);
                return;
            }
            
            // Display all history items or filter them if filterText is provided
            const itemsToShow = filterText.trim() 
                ? searchHistory.filter(item => item.toLowerCase().includes(filterText.toLowerCase()))
                : searchHistory;
                
            itemsToShow.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // Create text span for the search term
                const textSpan = document.createElement('span');
                textSpan.className = 'history-item-text';
                textSpan.textContent = item;
                historyItem.appendChild(textSpan);
                
                // Create delete button
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-history-item';
                deleteBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                `;
                
                // Add click event for delete button
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent the historyItem click event
                    removeFromSearchHistory(item);
                });
                
                historyItem.appendChild(deleteBtn);
                
                // Add click event for the history item
                historyItem.addEventListener('click', function() {
                    document.getElementById('searchInput').value = item;
                    applyFilters();
                    historyContainer.classList.remove('show');
                });
                
                historyContainer.appendChild(historyItem);
            });
            
            // Add clear all button
            const clearButton = document.createElement('div');
            clearButton.className = 'search-history-clear';
            clearButton.textContent = 'Clear All History';
            clearButton.addEventListener('click', function(e) {
                e.stopPropagation();
                clearSearchHistory();
            });
            
            historyContainer.appendChild(clearButton);
        }
        
        // Remove a specific item from search history
        function removeFromSearchHistory(query) {
            let history = getSearchHistory();
            
            // Filter out the item to remove
            history = history.filter(item => item !== query);
            
            // Save updated history back to localStorage
            localStorage.setItem('leadSearchHistory', JSON.stringify(history));
            
            // Refresh the display
            displaySearchHistory();
        }
        
        // Get search history from localStorage
        function getSearchHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('leadSearchHistory') || '[]');
                // If we have the old format with objects, extract just the queries
                if (history.length > 0 && typeof history[0] === 'object' && history[0].query) {
                    return history.map(item => item.query);
                }
                return history;
            } catch (e) {
                console.error('Error parsing search history:', e);
                return [];
            }
        }
        
        // Add a search query to history
        function addToSearchHistory(query) {
            if (!query || query.length < 3) return;
            
            let history = getSearchHistory();
            
            // Remove duplicates
            history = history.filter(item => item.toLowerCase() !== query.toLowerCase());
            
            // Add new query at the beginning
            history.unshift(query);
            
            // Limit to 10 items
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            // Save to localStorage
            localStorage.setItem('leadSearchHistory', JSON.stringify(history));
            
            // Refresh the display
            displaySearchHistory();
        }
        
        // Load search history
        function loadSearchHistory() {
        }

        // Hide flash messages after 5 seconds (5000 ms)
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.querySelectorAll('.success-message').forEach(function(msg) {
                    msg.style.transition = 'opacity 0.5s';
                    msg.style.opacity = 0;
                    setTimeout(function() {
                        msg.style.display = 'none';
                    }, 500); // Wait for fade out
                });
            }, 5000); // 5 seconds
        });

        function deleteLead(leadId) {
            if (confirm('Are you sure you want to delete this lead?')) {
                fetch(`/leads/${leadId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page or remove the row
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the lead');
                });
            }
        }

        function submitSearch() {
            const search = document.getElementById('searchInput').value;
            const params = new URLSearchParams(window.location.search);
            if (search) params.set('search', search); else params.delete('search');
            params.set('page', 1); // reset to page 1
            window.location.search = params.toString();
        }
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') submitSearch();
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.btn-pagination').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          if (btn.tagName === 'A' && btn.getAttribute('href')) {
            window.location.href = btn.getAttribute('href');
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
          }
        }, true);
        btn.addEventListener('mousedown', function(e) {
          if (btn.tagName === 'A' && btn.getAttribute('href')) {
            window.location.href = btn.getAttribute('href');
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
          }
        }, true);
      });
    });
    </script>
{% endblock %}
